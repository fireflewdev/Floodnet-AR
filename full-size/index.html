<!DOCTYPE html>
<html>
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<script>
    // Workaround for an AR.js bug (https://github.com/jeromeetienne/AR.js/issues/410)
    const sceneEl = document.querySelector("a-scene");
    sceneEl.addEventListener("loaded", () => {
        sceneEl.camera = new THREE.PerspectiveCamera();
    });
</script>
<script>
    window.onload = () => {
        // Grab the marker and all our rings so we access them in the script
        const marker = document.querySelector("a-marker");
        const donuts = document.querySelectorAll("a-torus");

        // Keep track of the first time the upper marker is detected
        // for the purposes of starting animation at that time
        let previouslyFound = false;

        function sleep(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        async function startSoundBeamDown() {
            sleep(400)
                .then(() => {
                    donuts[0].emit("ringLaunch");
                    donuts[0].object3D.visible = true;
                    console.log("ring one emitted");
                })
                .then(() => sleep(400))
                .then(() => {
                    donuts[1].emit("ringLaunch");
                    donuts[1].object3D.visible = true;
                    console.log("ring two emitted");
                })
                .then(() => sleep(400))
                .then(() => {
                    donuts[2].emit("ringLaunch");
                    donuts[2].object3D.visible = true;
                    console.log("ring three emitted");
                });
        }

        async function startSoundBeamUp() {
            sleep(400)
                .then(() => {
                    donuts[3].emit("ringLaunchRev");
                    donuts[3].object3D.visible = true;
                })
                .then(() => sleep(400))
                .then(() => {
                    donuts[4].emit("ringLaunchRev");
                    donuts[4].object3D.visible = true;
                })
                .then(() => sleep(400))
                .then(() => {
                    donuts[5].emit("ringLaunchRev");
                    donuts[5].object3D.visible = true;
                });
        }

        function launchPartnerRingDown(index) {
            // avoid out of bounds errors since there are only 6 rings
            if (index < 6) {
                donuts[index].emit("ringLaunch");
                donuts[index].object3D.visible = true;
            }
        }

        function launchPartnerRingUp(index) {
            // don't let index go negative
            if (index >= 0) {
                donuts[index].emit("ringLaunchRev");
                donuts[index].object3D.visible = true;
            }
        }

        // Each ring will launch the corresponding partner ring when it finishes an animation
        donuts.forEach((elem, index) => {
            // All rings should be invisible at the start
            elem.object3D.visible = false;

            elem.addEventListener("animationcomplete__pos", () => {
                elem.object3D.visible = false;
                launchPartnerRingDown(index + 3);
            });

            elem.addEventListener("animationcomplete__posrev", () => {
                elem.object3D.visible = false;
                launchPartnerRingUp(index - 3);
            });
        });

        // The whole animation sequence should start for the first time when the upper marker is first detected
        marker.addEventListener("markerFound", async () => {
            console.log("markerFound event was received");

            if (previouslyFound) {
                return;
            }

            previouslyFound = true;

            startSoundBeamDown();
        });

        // When the first and last rings finish the up and down animations respectively,
        // they trigger the opposite animation to make the beam bounce

        donuts[5].addEventListener("animationcomplete__pos", () => {
            startSoundBeamUp();
        });

        donuts[0].addEventListener("animationcomplete__posrev", () => {
            startSoundBeamDown();
        });
    };
</script>

<body style="margin: 0px; overflow: hidden">
    <script src="../entities.js"></script>

    <a-scene embedded vr-mode-ui="enabled: false" arjs="debugUIEnabled: false;">
        <a-assets>
            <a-asset-item id="sensor-obj" src="../assets/sensor.obj"></a-asset-item>
            <a-asset-item id="sensor-anim" src="../assets/GLTFfloodnet.gltf"></a-asset-item>
        </a-assets>

        <a-marker type="pattern" smooth smoothCount="10" smoothTolerance="0.05" smoothThreshold="1" emitevents
            url="../marker/floodnet-pattern.patt">
            <a-entity position="-2 0.5 -1" rotation="-90 0 0" text="width: 2; value: The sensor sends an ultrasonic pulse out at 40kHz which travels through the air and if there is an obstacle or object, it will bounce back to the sensor.  By calculating the travel time and the speed of sound, the distance can be calculated.;
                color: #FFF;
                wrapPixels: 500;
                align: center;">
            </a-entity>
            <a-entity position="-2 0.45 -1" rotation="-90 0 0" geometry="primitive: plane; width: 2; height: 2"
                material="side: double; color: #172130; transparent: true; opacity: 0.5">

            </a-entity>

            <a-torus position="0 0 -6" radius="0.5" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>
            <a-torus position="0 0 -6" radius="0.5" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>
            <a-torus position="0 0 -6" radius="0.5" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>

        </a-marker>
        <a-marker preset="hiro">
            <a-entity position="0 0.5 0" rotation="-90 0 0" geometry="primitive: plane; width: auto; height: auto"
                planepadder="padding: 0.2" material="color: #172130;" text="width: 2; value: floodnet! -newer!...;
                color: #FFF;
                wrapPixels: 500;
                align: center;">
            </a-entity>
            <a-torus position="0 0 -1" radius="1.25" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>
            <a-torus position="0 0 -1" radius="1.25" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>
            <a-torus position="0 0 -1" radius="1.25" radius-tubular="0.08"
                material="color: white; transparent: true; opacity: 0.8"
                animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
                animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
                animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev">
            </a-torus>
            <a-plane position="0 4 8" visible="true"
                material="side: double; color: #0000FF; transparent: true; opacity: 0.5" width="20" height="20"
                rotation="0 0 0"></a-plane>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
</body>

</html>