<!DOCTYPE html>
<html>
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
<script>
    // Workaround for an AR.js bug (https://github.com/jeromeetienne/AR.js/issues/410)
    const sceneEl = document.querySelector('a-scene');
    sceneEl.addEventListener('loaded', () => {
        sceneEl.camera = new THREE.PerspectiveCamera();
    });
</script>
<script>
    window.onload = () => {
      const marker = document.querySelector("a-marker");
      console.log("window load code is running");
      const hostEntity = document.querySelector("a-entity");
      let previouslyFound = false;

        let donuts = document.querySelectorAll("a-torus");

      console.log(donuts);

      donuts.forEach((elem, index) => {
        elem.object3D.visible = false;
        
        elem.addEventListener("animationcomplete__pos", () => {
          elem.object3D.visible = false;
          // console.log(
          //   "position animation event for ring " + (index + 1) + " finished"
          // );
          // console.log(elem);
          // console.log("------------------");
          let lowerRingIndex = index + 3;
          if (lowerRingIndex < 6) {
            donuts[lowerRingIndex].emit("ringLaunch");
            donuts[lowerRingIndex].object3D.visible = true;
          }
        });

        elem.addEventListener("animationcomplete__posrev", () => {
          elem.object3D.visible = false;

          console.log("reverse animation completed")

          let upperRingIndex = index - 3;
          if (upperRingIndex >= 0) {
            donuts[upperRingIndex].emit("ringLaunchRev");
            donuts[upperRingIndex].object3D.visible = true;
          }
        })
      });

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      marker.addEventListener("markerFound", async () => {
        console.log("markerFound event was received");

        if (previouslyFound) {
          return
        }
        
        sleep(400)
          .then(() => {
            donuts[0].emit("ringLaunch");
            donuts[0].object3D.visible = true;
            console.log("ring one emitted");
          })
          .then(() => sleep(400))
          .then(() => {
            donuts[1].emit("ringLaunch");
            donuts[1].object3D.visible = true;
            console.log("ring two emitted");
          })
          .then(() => sleep(400))
          .then(() => {
            donuts[2].emit("ringLaunch");
            donuts[2].object3D.visible = true;
            console.log("ring three emitted");
          });

        donuts[5].addEventListener("animationcomplete__pos", async () => {
          console.log("starting reverse soundwave");

          sleep(400)
            .then(() => {
              donuts[3].emit("ringLaunchRev");
              donuts[3].object3D.visible = true;
            })
            .then(() => sleep(400))
            .then(() => {
              donuts[4].emit("ringLaunchRev");
              donuts[4].object3D.visible = true;
            })
            .then(() => sleep(400))
            .then(() => {
              donuts[5].emit("ringLaunchRev");
              donuts[5].object3D.visible = true;
            });
        });

        previouslyFound = true;

        // let state = 0;

            // let animate = setInterval(() => {

            //   donuts.forEach((elem, index) => {
            //     elem.object3D.visible = (index < state)
            //   })

            //   state = (state + 1) % 5;
            // }, 300)

            // let newMarkerPosition = marker.object3D.position;
            // let newMarkerRotation = marker.object3D.rotation;

            // let recents = {
            //   position: [newMarkerPosition],
            //   rotation: [newMarkerRotation],
            // };

            // const avgVectors = (vectors) => {
            //   let x = 0;
            //   let y = 0;
            //   let z = 0;
            //   const len = vectors.length;

            //   vectors.forEach((v) => {
            //     x += v.x;
            //     y += v.y;
            //     z += v.z;
            //   });

            //   x = x / len;
            //   y = y / len;
            //   z = z / len;

            //   return {
            //     x: x,
            //     y: y,
            //     z: z,
            //   };
            // };

            // let smoothUpdate = setInterval(() => {
            //   newMarkerPosition = marker.object3D.position;
            //   newMarkerRotation = marker.object3D.rotation;

            //   if (recents.position.length >= 1000) {
            //     recents.position.shift();
            //     recents.rotation.shift();
            //   }

            //   recents.position.push(newMarkerPosition);
            //   recents.rotation.push(newMarkerRotation);

            //   let newObjPos = avgVectors(recents.position);
            //   let newObjRot = avgVectors(recents.rotation);

            //   hostEntity.object3D.position.set(newObjPos.x, newObjPos.y, newObjPos.z);
            //   hostEntity.object3D.rotation.set(newObjRot.x, newObjRot.y, newObjRot.z);
            // }, 15);

        
      });
    };
</script>

<body style="margin: 0px; overflow: hidden">
    <script src="entities.js"></script>

    <a-scene
      embedded
      embedded
      vr-mode-ui="enabled: false"
      arjs="debugUIEnabled: false;"
    >
      <a-assets>
        <a-asset-item id="sensor-obj" src="assets/sensor.obj"></a-asset-item>
        <a-asset-item
          id="sensor-anim"
          src="assets/GLTFfloodnet.gltf"
        ></a-asset-item>
      </a-assets>

      <a-marker type="pattern" emitevents url="./marker/floodnet-pattern.patt">
        <a-entity
          position="0 0.5 0"
          rotation="-90 0 0"
          geometry="primitive: plane; width: auto; height: auto"
          planepadder="padding: 0.2"
          material="color: #172130;"
          text="width: 2; value: floodnet! -newer!...;
                color: #FFF;
                wrapPixels: 500;
                align: center;" event-set__enter="_event: mouseenter: material.color = #26364f"
                event-set__leave="_event: mouseleave; material.color: #172130">
            </a-entity>

        <a-torus
          position="0 0 -6"
          radius="0.5"
          radius-tubular="0.08"
          material="color: red"
          animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus>
        <a-torus
          position="0 0 -6"
          radius="0.5"
          radius-tubular="0.08"
          material="color: green"
          animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus
        ><a-torus
          position="0 0 -6"
          radius="0.5"
          radius-tubular="0.08"
          material="color: blue"
          animation__pos="property: position; from: 0 0 -6; to: 0 0 3; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 3; to: 0 0 -6; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus>

            <!-- <a-ring
          position="0 0 -1"
          material="side: double; color: #007DDE; transparent: true; opacity: 0.5"
          radius-inner="1"
          radius-outer="2"
        ></a-ring>

        <a-ring
          position="0 0 -5"
          material="side: double; color: #DE0000; transparent: true; opacity: 0.5"
          radius-inner="1"
          radius-outer="2"
        ></a-ring> -->
      </a-marker>
      <a-marker preset="hiro">
        <a-entity
          position="0 0.5 0"
          rotation="-90 0 0"
          geometry="primitive: plane; width: auto; height: auto"
          planepadder="padding: 0.2"
          material="color: #172130;"
          text="width: 2; value: floodnet! -newer!...;
                color: #FFF;
                wrapPixels: 500;
                align: center;"
          event-set__enter="_event: mouseenter: material.color = #26364f"
          event-set__leave="_event: mouseleave; material.color: #172130"
        >
        </a-entity>
        <a-torus
          position="0 0 -1"
          radius="1.25"
          radius-tubular="0.08"
          material="color: red"
          animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus>
        <a-torus
          position="0 0 -1"
          radius="1.25"
          radius-tubular="0.08"
          material="color: green"
          animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus>
        <a-torus
          position="0 0 -1"
          radius="1.25"
          radius-tubular="0.08"
          material="color: blue"
          animation__pos="property: position; from: 0 0 -1; to: 0 0 8; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__rad="property: radius; from: 1.25; to: 2; dur: 2000; easing: linear; startEvents: ringLaunch"
          animation__posrev="property: position; from: 0 0 8; to: 0 0 -1; dur: 2000; easing: linear; startEvents: ringLaunchRev"
          animation__radrev="property: radius; from: 0.5; to: 1.25; dur: 2000; easing: linear; startEvents: ringLaunchRev"
        ></a-torus>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
</body>

</html>